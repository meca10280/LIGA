<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>LIGA: Experiencia Inmersiva</title>

    <script src="js/aframe.min.js"></script>
    <script src="js/aframe-ar.js"></script>
    <script src="js/gesture-detector.js"></script>
    <script src="js/gesture-handler.js"></script>

    <script>
        AFRAME.registerComponent('dynamic-image-loader', {
            schema: {
                cardSrc: { type: 'string' }
            },
            init: function () {
                const marker = this.el;
                let imageEl = null;

                // Evento que se dispara cuando el marcador es detectado
                marker.addEventListener('markerFound', () => {
                    if (!imageEl) {
                        // Creaci칩n y configuraci칩n del elemento a-image
                        imageEl = document.createElement('a-image');
                        imageEl.setAttribute('src', this.data.cardSrc);
                        imageEl.setAttribute('scale', '1 1 1');
                        imageEl.setAttribute('rotation', '-90 0 0');
                        imageEl.setAttribute('class', 'clickable');
                        imageEl.setAttribute('gesture-handler', '');

                        // Adjuntar la imagen al marcador
                        marker.appendChild(imageEl);
                        console.log(`Cargando imagen para el marcador: ${this.data.cardSrc}`);
                    }
                });

                // Evento que se dispara cuando el marcador se pierde
                marker.addEventListener('markerLost', () => {
                    if (imageEl) {
                        // Eliminar la imagen del DOM para liberar recursos
                        marker.removeChild(imageEl);
                        imageEl = null;
                        console.log(`Eliminando imagen del marcador: ${this.data.cardSrc}`);
                    }
                });
            }
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene
        vr-mode-ui="enabled: false;"
        loading-screen="enabled: false;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        id="scene"
        embedded
        gesture-detector
    >
        <a-entity id="marker-container"></a-entity>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('marker-container');
            const numMarkers = 24; // De 00 a 23

            for (let i = 0; i < numMarkers; i++) {
                const marker = document.createElement('a-marker');
                const markerId = `marker${String(i).padStart(2, '0')}`;
                const pattUrl = `patts/code${String(i).padStart(2, '0')}.patt`;
                const cardSrc = `cards/card${String(i).padStart(2, '0')}.png`;

                // Configuraci칩n del marcador
                marker.setAttribute('id', markerId);
                marker.setAttribute('type', 'pattern');
                marker.setAttribute('preset', 'custom');
                marker.setAttribute('url', pattUrl);
                marker.setAttribute('raycaster', 'objects: .clickable');
                marker.setAttribute('emitevents', 'true');
                marker.setAttribute('cursor', 'fuse: false; rayOrigin: mouse;');

                // Usar el nuevo componente para la carga diferida
                marker.setAttribute('dynamic-image-loader', `cardSrc: ${cardSrc}`);

                container.appendChild(marker);
            }

            console.log('Marcadores generados din치micamente.');
        });
    </script>
</body>
</html>
